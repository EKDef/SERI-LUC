---
title: "SERI-LUC notebook"
output: html_document
date: "2024-12-10"
---

Load Packages
```{r Load packages, include=FALSE}
library(sf)
library(tidyverse)
library(ggplot2)
library(Cairo)
library(nomisr)
```

Load Data
```{r Load data, include=FALSE}
#Load 2021 MSOA boundary file
MSOA_21_boundary <- st_read("/dbfs/mnt/base/unrestricted/source_ons_open_geography_portal/dataset_middle_s_o_a_2021_ew_bfe/format_SHP_middle_s_o_a_2021_ew_bfe/LATEST_middle_s_o_a_2021_ew_bfe/MSOA_2021_EW_BFC_V7.shp")

#Load 2011 MSOA boundary file
MSOA_11_boundary <- st_read("/dbfs/mnt/lab/unrestricted/elmantas.kamaitis@defra.gov.uk/Middle_layer_Super_Output_Areas_Dec_2011_Boundaries_Full_Clipped_BFC_EW_V3_2022_942885142986844588.gpkg")

#Load Business Register and Employment Survey data on the number of workers per 4-digit 2007 SIC industry working in each 2011 MSOA
bres_sec_emp <- nomis_get_data(
  id = "NM_189_1",
  geography = "TYPE297",
  date = "latest",
  industry = "TYPE33",
  employment_status = 1,
  measure = 1,
  measures = 20100
)

#Load Census 2021 data on the number of 
census_sec_emp <- nomis_get_data(
  id = "NM_2081_1",
  geography = "TYPE152",
  c2021_occ_105 = "0...104",
  measures = 20100
)

```
##### BRES based analysis #####

Summing by industry and merging with MSOA boundaries
```{r}
# Summing OBS_VALUE for each unique GEOGRAPHY
summed_df <- bres_sec_emp %>%
  group_by(GEOGRAPHY, GEOGRAPHY_CODE) %>%
  summarise(SUM_OBS_TOTAL = sum(as.numeric(OBS_VALUE), na.rm = TRUE), .groups = 'drop')

# Summing OBS_VALUE for all 4-digit INDUSTRY_CODE that start with "01" and are therefore in agri-industries for each unique GEOGRAPHY
summed_industry_df <- bres_sec_emp %>%
  filter(substr(INDUSTRY_CODE, 1, 2) == "01") %>%
  group_by(GEOGRAPHY) %>%
  summarise(SUM_OBS_AGRI = sum(as.numeric(OBS_VALUE), na.rm = TRUE))

# Merge the two dataframes to combine the results
final_df <- left_join(summed_df, summed_industry_df, by = "GEOGRAPHY")

# Calculate the percentage of SUM_OBS_AGRI in SUM_OBS_TOTAL for each GEOGRAPHY
final_df <- final_df %>%
  mutate(AGRI_PERCENTAGE = (SUM_OBS_AGRI / SUM_OBS_TOTAL) * 100)

# Filter the MSOA boundary and final_df data to include only entries for England
filtered_boundary <- MSOA_11_boundary %>%
  filter(substr(MSOA11CD, 1, 1) == "E")

filtered_final_df <- final_df %>%
  filter(substr(GEOGRAPHY_CODE, 1, 1) == "E")

# Merge the employment sums data with the MSOA boundary file
merged_data <- left_join(filtered_boundary, filtered_final_df, by = c("MSOA11CD" = "GEOGRAPHY_CODE"))

```
Summary Stats
```{r}

summary(merged_data$AGRI_PERCENTAGE)

summary(merged_data$SUM_OBS_TOTAL)

total_sum_obs <- merged_data %>%
  st_drop_geometry() %>%  # Drop geometry to simplify the operation
  summarise(Total_SUM_OBS_TOTAL = sum(SUM_OBS_TOTAL, na.rm = TRUE))

# Create a histogram for AGRI_PERCENTAGE
ggplot(data = merged_data, aes(x = AGRI_PERCENTAGE)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "black", alpha = 0.7) +
  labs(
    title = "Histogram of Agriculture Percentage",
    x = "Agriculture Percentage",
    y = "Frequency"
  ) +
  theme_minimal()


# Process and bin AGRI_PERCENTAGE, dropping geometry and unnecessary columns
bin_counts <- merged_data %>%
  st_drop_geometry() %>%  # Remove geometry column
  mutate(
    AGRI_PERCENTAGE_BIN = case_when(
      AGRI_PERCENTAGE == 0 ~ "0",  # Bin for exactly 0 values
      AGRI_PERCENTAGE > 0 & AGRI_PERCENTAGE <= 0.5 ~ "Near Zero (0 to 0.5)",  # Bin for near-zero values
      TRUE ~ cut(AGRI_PERCENTAGE, breaks = seq(0.5, 100, by = 0.5), include.lowest = TRUE, right = FALSE)  # Other bins
    )
  ) %>%
  count(AGRI_PERCENTAGE_BIN, name = "Count") %>%  # Count occurrences in each bin
  arrange(AGRI_PERCENTAGE_BIN)  # Sort bins

# Print the resulting table
print(bin_counts)

```
Map plots for percentage and total agri employment
```{r}

##### Total employment plot #####
# Calculate the threshold for the upper 5% of SUM_OBS_TOTAL
threshold <- quantile(merged_data$SUM_OBS_TOTAL, 0.95, na.rm = TRUE)

# Add a new column to classify regions as top 5% or not
merged_data <- merged_data %>%
  mutate(SUM_OBS_CATEGORY = ifelse(SUM_OBS_TOTAL >= threshold, "Top 5%", "Other"))

# Plot the data 5% excluded total employment data
ggplot(data = merged_data) +  
  geom_sf(data = merged_data %>% filter(SUM_OBS_CATEGORY == "Other"), # Separate the fill aesthetic for the two categories
          aes(fill = ifelse(SUM_OBS_TOTAL == 0, NA, SUM_OBS_TOTAL)), color = "grey", size = 0.1) +
  geom_sf(data = merged_data %>% filter(SUM_OBS_CATEGORY == "Top 5%"), 
          fill = "red", color = "grey", size = 0.1) +
  scale_fill_viridis_c(option = "plasma", na.value = "white", name = "Employment Count") +  # Continuous fill scale for values excluding top 5%
  theme_minimal() +
  labs(title = "Total Employment by MSOA",
       subtitle = "Top 5% areas highlighted in red") +
  theme(legend.position = "right", 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 48, hjust = 0.5),      # Adjust title size
        plot.subtitle = element_text(size = 44, hjust = 0.5),   # Adjust subtitle size
        legend.title = element_text(size = 32),                 # Adjust legend title size
        legend.text = element_text(size = 30),                  # Adjust legend text size
        axis.text = element_text(size = 30),                    # Adjust axis text size
        legend.key.height = unit(4.5, "cm"),                    # Adjust the height of the legend key
        legend.key.width = unit(4.5, "cm")                      # Adjust the width of the legend key
  )

# Save the plot
ggsave("employ_5pct_total_MSOA.png", device = "png", width = 45, height = 45, dpi = 200)

##### Agriculture proportion employment #####
# Map agriculture proportion of total employment
ggplot(data = merged_data) +
  geom_sf(aes(fill = ifelse(AGRI_PERCENTAGE == 0, NA, AGRI_PERCENTAGE)), color = "grey", size = 0.001) + 
  # Boundary lines are grey, areas with 0 are set to NA
  scale_fill_viridis_c(option = "plasma", na.value = "white", name = "Agriculture %") +  
  # White for areas with 0 values
  theme_minimal() +
  labs(title = "Agricultural related employment percentage by 2011 MSOA",
       subtitle = "Agricultural (SIC 2007 01**) employment as a percentage of total employment using BRES data") +
  theme(legend.position = "right", 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 48, hjust = 0.5),      # Adjust title size
        plot.subtitle = element_text(size = 44, hjust = 0.5),   # Adjust subtitle size
        legend.title = element_text(size = 32),                 # Adjust legend title size
        legend.text = element_text(size = 30),                  # Adjust legend text size
        axis.text = element_text(size = 30),                    # Adjust axis text size
        legend.key.height = unit(4.5, "cm"),                    # Adjust the height of the legend key
        legend.key.width = unit(4.5, "cm")                      # Adjust the width of the legend key
        )

# Save the plot
ggsave("agri_percentage_BRES.png", device = "png", width = 45, height = 45, dpi = 200)

##### Agriculture total employment #####
# Map agriculture employment
ggplot(data = merged_data) +
  geom_sf(aes(fill = ifelse(SUM_OBS_AGRI == 0, NA, SUM_OBS_AGRI)), color = "grey", size = 0.001) + 
  # Boundary lines are grey, areas with 0 are set to NA
  scale_fill_viridis_c(option = "plasma", na.value = "white", name = "Agriculture Employment Count") +  
  # White for areas with 0 values
  theme_minimal() +
  labs(title = "Agricultural Employment by MSOA",
       subtitle = "Agricultural employment by MSOA in England") +
  theme(legend.position = "right", 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

# Save the plot
ggsave("agri_total_MSOA.png", device = "png", width = 45, height = 45, dpi = 200)

# Calculate the threshold for the upper 0.1% of SUM_OBS_TOTAL
threshold <- quantile(merged_data$SUM_OBS_AGRI, 0.999, na.rm = TRUE)

# Add a new column to classify regions as top 0.1% or not
merged_data <- merged_data %>%
  mutate(SUM_OBS_CATEGORY = ifelse(SUM_OBS_AGRI >= threshold, "Top 0.1%", "Other"))

# Plot the data 0.5% excluded total employment data
ggplot(data = merged_data) +  
  geom_sf(data = merged_data %>% filter(SUM_OBS_CATEGORY == "Other"), # Separate the fill aesthetic for the two categories
          aes(fill = ifelse(SUM_OBS_AGRI == 0, NA, SUM_OBS_AGRI)), color = "grey", size = 0.1) +
  geom_sf(data = merged_data %>% filter(SUM_OBS_CATEGORY == "Top 0.1%"), 
          fill = "red", color = "grey", size = 0.1) +
  scale_fill_viridis_c(option = "plasma", na.value = "white", name = "Agri employment Count") +  # Continuous fill scale for values excluding top 5%
  theme_minimal() +
  labs(title = "Agri employment by MSOA",
       subtitle = "Top 0.1% areas highlighted in red") +
  theme(legend.position = "right", 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 48, hjust = 0.5),      # Adjust title size
        plot.subtitle = element_text(size = 44, hjust = 0.5),   # Adjust subtitle size
        legend.title = element_text(size = 32),                 # Adjust legend title size
        legend.text = element_text(size = 30),                  # Adjust legend text size
        axis.text = element_text(size = 30),                    # Adjust axis text size
        legend.key.height = unit(4.5, "cm"),                    # Adjust the height of the legend key
        legend.key.width = unit(4.5, "cm")                      # Adjust the width of the legend key
  )

# Save the plot
ggsave("agri_01pct_total_MSOA.png", device = "png", width = 45, height = 45, dpi = 200)


```

##### Census based analysis #####

```{r}
# Filter and summarize census data for the required categories
filtered_census_data <- census_sec_emp %>%
  filter(C2021_OCC_105 %in% c(0, 60)) %>%   # Retain rows where C2021_OCC_105 is 0 or 60
  mutate(Category = case_when(
    C2021_OCC_105 == 0 ~ "SUM_OBS_TOTAL",  # Rename categories
    C2021_OCC_105 == 60 ~ "SUM_OBS_AGRI"
  )) %>%
  group_by(GEOGRAPHY_CODE, Category) %>%    # Group by geography and category
  summarise(SUM_OBS_VALUE = sum(OBS_VALUE, na.rm = TRUE), .groups = "drop") %>% 
  pivot_wider(names_from = Category, values_from = SUM_OBS_VALUE, values_fill = 0)  # Reshape to wide format

# Merge the summarised census data with the shapefile
census_merged_data <- MSOA_21_boundary %>%
  filter(str_starts(MSOA21CD, "E")) %>%  # Filter MSOA21CD to include only those starting with "E"
  left_join(filtered_census_data, by = c("MSOA21CD" = "GEOGRAPHY_CODE")) %>%
  mutate(
    AGRI_PERCENTAGE = ifelse(SUM_OBS_TOTAL > 0, SUM_OBS_AGRI / SUM_OBS_TOTAL * 100, NA)  # Calculate percentage
  )

```

```{r}

##### Agriculture proportion employment #####
# Map agriculture proportion of total employment
ggplot(data = census_merged_data) +
  geom_sf(aes(fill = ifelse(AGRI_PERCENTAGE == 0, NA, AGRI_PERCENTAGE)), color = "grey", size = 0.001) + 
  # Boundary lines are grey, areas with 0 are set to NA
  scale_fill_viridis_c(option = "plasma", na.value = "white", name = "Agriculture %") +  
  # White for areas with 0 values
  theme_minimal() +
  labs(title = "Agricultural and Related Trades by 2021 MSOA",
       subtitle = "Agricultural and Related Trades as a percentage of total employment using Census 2021 data") +
  theme(legend.position = "right", 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 48, hjust = 0.5),      # Adjust title size
        plot.subtitle = element_text(size = 44, hjust = 0.5),   # Adjust subtitle size
        legend.title = element_text(size = 32),                 # Adjust legend title size
        legend.text = element_text(size = 30),                  # Adjust legend text size
        axis.text = element_text(size = 30),                    # Adjust axis text size
        legend.key.height = unit(4.5, "cm"),                    # Adjust the height of the legend key
        legend.key.width = unit(4.5, "cm")                      # Adjust the width of the legend key
  )

# Save the plot
ggsave("agri_percentage_census.png", device = "png", width = 45, height = 45, dpi = 200)

```

```{r}

# Process the census data
processed_data <- census_sec_emp %>%
  filter(str_starts(GEOGRAPHY_CODE, "E")) %>%  # Filter for GEOGRAPHY_CODE starting with "E"
  group_by(GEOGRAPHY_CODE) %>%  # Group by each unique GEOGRAPHY_CODE
  mutate(
    # Get the OBS_VALUE where C2021_OCC_105 is 0 for each GEOGRAPHY_CODE
    Total_OBS_VALUE = OBS_VALUE[C2021_OCC_105 == 0],
    # Divide each OBS_VALUE by the Total_OBS_VALUE
    PERC_OBS_VALUE = ifelse(!is.na(Total_OBS_VALUE) & Total_OBS_VALUE > 0, OBS_VALUE / Total_OBS_VALUE, NA)
  ) %>%
  ungroup()  # Ungroup after processing

# Extract the top 3 values for each GEOGRAPHY_CODE, excluding rows where C2021_OCC_105 == 0
top_3_values <- processed_data %>%
  group_by(GEOGRAPHY_CODE) %>%
  filter(!is.na(PERC_OBS_VALUE) & C2021_OCC_105 != 0) %>%  # Exclude the overall total
  arrange(desc(PERC_OBS_VALUE)) %>%
  slice_max(order_by = PERC_OBS_VALUE, n = 3, with_ties = FALSE) %>%
  mutate(Rank = row_number()) %>%
  ungroup()

# Reshape the data to wide format, creating separate columns for the top 3 values and their names
top_3_wide <- top_3_values %>%
  select(GEOGRAPHY_CODE, Rank, PERC_OBS_VALUE, C2021_OCC_105_NAME) %>%
  pivot_wider(
    names_from = Rank,
    values_from = c(PERC_OBS_VALUE, C2021_OCC_105_NAME),
    names_prefix = "Top_"
  )

# Merge the result with MSOA_21_boundary
top_prop_employ <- MSOA_21_boundary %>%
  inner_join(top_3_wide, by = c("MSOA21CD" = "GEOGRAPHY_CODE"))

summary(top_prop_employ$PERC_OBS_VALUE_Top_1)

# Count appearances of unique values in C2021_OCC_105_NAME_Top_1
top_1_employ_counts <- top_prop_employ %>%
  st_drop_geometry() %>%  # Drop the geometry column
  count(C2021_OCC_105_NAME_Top_1, name = "Count") %>%
  arrange(desc(Count))

# View the sorted table
print(top_1_employ_counts)

# Count appearances of unique values in C2021_OCC_105_NAME_Top_2
top_2_employ_counts <- top_prop_employ %>%
  st_drop_geometry() %>%  # Drop the geometry column
  count(C2021_OCC_105_NAME_Top_2, name = "Count") %>%
  arrange(desc(Count))

# View the sorted table
print(top_2_employ_counts)

# Count appearances of unique values in C2021_OCC_105_NAME_Top_3
top_3_employ_counts <- top_prop_employ %>%
  st_drop_geometry() %>%  # Drop the geometry column
  count(C2021_OCC_105_NAME_Top_3, name = "Count") %>%
  arrange(desc(Count))

# View the sorted table
print(top_3_employ_counts)

```

```{r}
# Merge top_3_values with MSOA_21_boundary to include geometry
top_3_with_geometry <- top_3_values %>%
  inner_join(MSOA_21_boundary, by = c("GEOGRAPHY_CODE" = "MSOA21CD"))

# Filter for C2021_OCC_105_CODE == "_60"
filtered_top_3 <- top_3_with_geometry %>%
  filter(C2021_OCC_105_CODE == "_60")  # Keep rows where code is _60

# Plot the filtered data
ggplot(data = filtered_top_3) +
  geom_sf(aes(geometry = geometry, color = factor(Rank)), size = 0.5) +  # Use different colors for Rank
  scale_color_manual(
    values = c("red", "blue", "green"),  # Assign colors to Rank 1, 2, and 3
    name = "Rank",
    labels = c("Rank 1", "Rank 2", "Rank 3")  # Legend labels
  ) +
  theme_minimal() +
  labs(
    title = "Top 3 Ranks for C2021_OCC_105_CODE == _60",
    subtitle = "Ranks displayed in different colors",
    color = "Rank"
  ) +
  theme(
    legend.position = "right",
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank()
  )

# Filter MSOA_21_boundary for values where MSOA21CD starts with "E"
eng_MSOA_21_boundary <- MSOA_21_boundary %>%
  filter(startsWith(MSOA21CD, "E"))

# Plot the filtered data with boundaries underneath
ggplot() +
  # Add grey boundaries from MSOA_21_boundary
  geom_sf(data = eng_MSOA_21_boundary, fill = "transparent", colour = "grey", size = 0.5) + 
  # Add the filtered top 3 ranked locations
  geom_sf(data = filtered_top_3, aes(geometry = geometry, fill = factor(Rank)), size = 0.5) + 
  scale_fill_manual(
    values = c("red4", "orange4", "yellow4"),  # Assign colors to Rank 1, 2, and 3
    name = "Rank",
    labels = c("Rank 1", "Rank 2", "Rank 3")  # Legend labels
  ) +
  theme_minimal() +
  labs(
    title = "Agricultural and Related Trades main proportional employment industry",
    subtitle = "2021 MSOAs where Agricultural and Related Trades is the top 3 proportional employment industry using Census 2021 data",
    color = "Rank"
  ) +
  theme(legend.position = "right", 
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        plot.title = element_text(size = 48, hjust = 0.5),      # Adjust title size
        plot.subtitle = element_text(size = 44, hjust = 0.5),   # Adjust subtitle size
        legend.title = element_text(size = 32),                 # Adjust legend title size
        legend.text = element_text(size = 30),                  # Adjust legend text size
        axis.text = element_text(size = 30),                    # Adjust axis text size
        legend.key.height = unit(4.5, "cm"),                    # Adjust the height of the legend key
        legend.key.width = unit(4.5, "cm")                      # Adjust the width of the legend key
  )

ggsave("top3_employ_census.png", device = "png", width = 45, height = 45, dpi = 200)
```
